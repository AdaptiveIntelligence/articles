#An Introduction to OpenCV on iOS: Let's Build a Face Recognition App

##A Bit of Background

OpenCV is an open source computer vision and machine learning library. It contains thousands of optimized algorithms which provide a common toolkit for various computer vision applications. According to the project's [About page](http://opencv.org/about.html), OpenCV is being used in many applications ranging from stitching Street View images to running interactive art shows. ancient in our industry's time standards. 

OpenCV started out as a research project inside Intel in 1999. It has been in active development since then and evolved to support modern technologies like OpenCL and OpenGL and platforms like iOS and Android.

In 1999, [Half-Life](http://en.wikipedia.org/wiki/Half-Life_(video_game)) was just released and extremely popular. [Intel Pentium 3](http://en.wikipedia.org/wiki/Pentium_III) was the state of the art CPU and 400-500MHz clock speeds were considered fast. 

A typical CPU in 2006 when OpenCV 1.0 was released had about the same [CPU-performance](http://browser.primatelabs.com/geekbench2/compare/212009/1030202) as an iPhone 5.


##Overview of OpenCV

###Concepts

OpenCV is a C++ API consisting of various modules containing a wide range of functions from low level image color space conversions to high-level machine learning tools. 

Using C++ APIs for iOS development is not something most of us do daily. You need to use Objective-C++ for the files calling OpenCV methods, i.e. you cannot call OpenCV methods from Swift or Obj-C. The OpenCV [iOS tutorials](http://docs.opencv.org/doc/tutorials/ios/video_processing/video_processing.html#opencviosvideoprocessing) tell you to simply change file extensions to `.mm` for all classes where you'd like to use OpenCV, including view controllers. While this might work, it is not a good idea. The correct approach is to write Obj-C++ wrapper classes for all OpenCV functionality you would like to use in your app. These Obj-C++ classes then can be used transparently in all Obj-C classes. Going the wrapper route, you will be able to contain C++ code in your project to the wrappers and most-likely save lots of headache further down the road resolving hard to track compile errors because a C++ header got erroneously included in a wrong file.

OpenCV declares the `cv` namespace, such that classes are prefixed with `cv::` like `cv::Mat`, `cv::Algorithm` etc. It is possible to use `using namespace cv` in your `.mm` files in order to be able to drop the `cv::` prefixes for a lot of classes but you will still need to write them out for classes like `cv::Rect` and `cv::Point` due to collisions with `Rect` and `Point` defined in `MacTypes.h`. While it's a matter of personal preference, it is more consistent to simply use `cv::` everywhere.

###Modules

Below is a list of most important modules as described in the [official documentation](http://docs.opencv.org/modules/core/doc/intro.html):

- **core**: a compact module defining basic data structures, including the dense multi-dimensional array Mat and basic functions used by all other modules.
- **imgproc**: an image processing module that includes linear and non-linear image filtering, geometrical image transformations (resize, affine and perspective warping, generic table-based remapping), color space conversion, histograms, and so on.
- **video**: a video analysis module that includes motion estimation, background subtraction, and object tracking algorithms.
- **calib3d**: basic multiple-view geometry algorithms, single and stereo camera calibration, object pose estimation, stereo correspondence algorithms, and elements of 3D reconstruction.
- **features2d**: salient feature detectors, descriptors, and descriptor matchers.
- **objdetect**: detection of objects and instances of the predefined classes (for example, faces, eyes, mugs, people, cars, and so on).
- **ml*: various machine learning algorithms such as K-Means, Support Vector Machines and Neural Networks.
- **highgui**: an easy-to-use interface to video capturing, image and video codecs, as well as simple UI capabilities. (only a subset available on iOS)
- **gpu**: GPU-accelerated algorithms from different OpenCV modules. (unavailable on iOS)
- **ocl**: Common algorithms implemented using OpenCL. (unavailable on iOS)
- a few more helper modules such as Python bindings and user contributed algorithms.


###Fundamental Classes and Operations 

OpenCV contains hundreds of classes. Let's limit ourselves to a few fundamental classes and operations in the interest of brewity and refer to the [full documentation](http://docs.opencv.org/modules/core/doc/core.html) as further reading. Going over these core classes should be enough to get a feel for the logic behind the library.

####`cv::Mat`

`cv::Mat` is the core data structure representing any n-dimensional matrix in OpenCV. Since images are just a special case of 2-D matrices, they are also represented by a `cv::Mat`, i.e. `cv::Mat` is the class you'll be working with the most in OpenCV.

An instance of `cv::Mat` acts as a header for the image data and contains information to specify the image format. The image data itself is only referenced and can be shared by multiple `cv::Mat` instances. OpenCV uses a reference counting method similar to ARC to make sure that the image data is deallocated when the last referencing `cv::Mat` is gone.Image data itself is an array of concatenated rows of the image. (for N-dimensional matrices, the data consist of concatenated data arrays of the contained N-1 dimensional matrices). Using the values contained in the `step[]` array each pixel of the image can be adressed using pointer arithmetic: 

````
uchar *pixelPtr = cvMat.data + rowIndex * cvMat.step[0] + colIndex * cvMat.step[1]
````

The data format for each pixel is retrieved by the `type()` function. In addition to common grayscale (1 channel, `CV_8UC1`) and color (3 channel, `CV_8UC3`) images with 8-bit unsigned integers per channel, OpenCV supports many less frequent formats such as `CV_16SC3` (16-bit signed integer with 3 channels per pixel) or even `CV_64FC4` (64-bit floating point with 4 channels per pixel). 

####`cv::Algorithm`

`Algorithm` is an abstract base class for many algorithms implemented in OpenCV, including the `FaceRecognizer` we will be using the demo project. It provides an API not unlike `CIFilter` where you can create an `Algorithm` by calling `Algorithm::create()` with the name of the algorithm and can set and get various parameters using the `get()` and `set()` methods, vaguely similar to key-value coding. Moreover, the `Algorithm` base provides functionality to save and load parameters to/from XML or YAML files.

####Image Conversions and Filters

##Using OpenCV on iOS 

###Adding OpenCV to your Project

You have three options to integrate OpenCV into your iOS project:

- Just use Cocoapods: `pod "OpenCV"`
- Download the official [iOS framework release](http://opencv.org/downloads.html) and add the framework to your project.
- Pull the sources from [Github](https://github.com/Itseez/opencv) and build the library on your own according to the instructions [here](http://docs.opencv.org/doc/tutorials/introduction/ios_install/ios_install.html#ios-installation).

###Objective-C++

##Demo: Face Detection and Recognition

//TODO: add a block diagram of the demo app here.

###Face Detection

###Face Recognition

##Further Reading
